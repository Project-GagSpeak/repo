# Updates the downloadcounts in the downloadcounts var in the json and updates the reflection to the latest commit as a squashed merge to avoid commit history spam.
name: Update Download Counts

on:
  schedule:
    - cron: '*/5 * * * *' # Runs at the start of every hour
  workflow_dispatch: # dispatches 

jobs:
  update-download-count:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v2
        
      - name: Disable Strict Host Key Checking for the server
        run: |
          mkdir -p ~/.ssh
          echo "Host ${{ secrets.SSH_PRIVATE_IP }}" > ~/.ssh/config
          echo "    HostName ${{ secrets.SSH_PRIVATE_IP }}" >> ~/.ssh/config
          echo "    User root" >> ~/.ssh/config
          echo "    IdentityFile $(pwd)/ssh_key" >> ~/.ssh/config
          echo "    StrictHostKeyChecking no" >> ~/.ssh/config
        env:
          SSH_PRIVATE_IP: ${{ secrets.SSH_PRIVATE_IP }}
      
      - name: Install SSH key
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}
      
      - name: Fetch download count from server
        id: fetch-count
        run: |
          # Replace with your server details
          SSH_HOST="${{ secrets.SSH_PRIVATE_IP }}"
          SSH_USER="root"
          TARGET_DIR="/var/www/files.kinkporium.studio/downloads"
          FILE_NAME="downloads.txt"
          
          # SSH into the server and fetch the download count
          DOWNLOAD_COUNT=$(ssh $SSH_USER@$SSH_HOST "cat $TARGET_DIR/$FILE_NAME")
          echo "Download count fetched: $DOWNLOAD_COUNT"
          echo "::set-output name=download_count::$DOWNLOAD_COUNT"
      
      - name: Update download counts in JSON
        run: |
          DOWNLOAD_COUNT=${{ steps.fetch-count.outputs.download_count }}
          JSON_FILE="projectgagspeak.json"
          
          # Use jq to update the download count in the JSON file
          jq --argjson count $DOWNLOAD_COUNT '.[0].DownloadCount = $count' $JSON_FILE > temp.json && mv temp.json $JSON_FILE
      
      - name: Amend or Create New Commit for Download Count Update
        run: |
          # Ensure the local repository is aware of remote changes
          git fetch origin main
          
          # Check out the main branch
          git checkout main
          
          # Ensure your local main branch is up to date
          git reset --hard origin/main
          
          # Get the latest commit message
          LATEST_COMMIT_MESSAGE=$(git log -1 --pretty=format:"%s")
          
          # Add changes to staging
          git add projectgagspeak.json
          
          # Determine if the last commit was an automated update
          if [[ "$LATEST_COMMIT_MESSAGE" == "Automated update of DownloadCount" ]]; then
            # Amend the last commit without changing its message
            git commit --amend --no-edit
            echo "Amended the last commit with the new download count."
          else
            # Create a new commit for the update
            git commit -m "Automated update of DownloadCount"
            echo "Created a new commit for the download count update."
          fi
          
          # Push the changes, using --force-with-lease for safety
          git push --force-with-lease origin main

        env:
          GIT_COMMITTER_NAME: "GitHub Action"
          GIT_AUTHOR_NAME: "GitHub Action"
          GIT_COMMITTER_EMAIL: "action@github.com"
          GIT_AUTHOR_EMAIL: "action@github.com"
